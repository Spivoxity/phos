/*
 * scrollbit.c
 *
 * This file is part of the Phos operating system for microcontrollers
 * Copyright (c) 2018 J. M. Spivey
 * All rights reserved
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/* This example displays scrolling text on the "scroll:bit", a
   micro:bit add-on from Pimoroni.  Its matrix of 17 x 7 white LEDs
   has an I2C-based driver chip */

#include "phos.h"
#include <string.h>

void i2c_write_buf(int addr, int cmd, byte *buf2, int n) {
     byte buf1 = cmd;
     int status = i2c_xfer(WRITE, addr, &buf1, 1, buf2, n);
     assert(status == OK);
}

#define CHARWD 6
#define CHARHT 7
#define DISPWD 17

/* map -- layout of the LED board */
const static byte map[CHARHT][DISPWD] = {
{ 134, 118, 102, 86, 70, 54, 38, 22, 6,  8, 24, 40, 56, 72, 88, 104, 120 }, 
{ 133, 117, 101, 85, 69, 53, 37, 21, 5,  9, 25, 41, 57, 73, 89, 105, 121 },
{ 132, 116, 100, 84, 68, 52, 36, 20, 4, 10, 26, 42, 58, 74, 90, 106, 122 },
{ 131, 115,  99, 83, 67, 51, 35, 19, 3, 11, 27, 43, 59, 75, 91, 107, 123 },
{ 130, 114,  98, 82, 66, 50, 34, 18, 2, 12, 28, 44, 60, 76, 92, 108, 124 },
{ 129, 113,  97, 81, 65, 49, 33, 17, 1, 13, 29, 45, 61, 77, 93, 109, 125 },
{ 128, 112,  96, 80, 64, 48, 32, 16, 0, 14, 30, 46, 62, 78, 94, 110, 126 }
};

/* font -- bitmaps for each character (see end of this file) */
const unsigned char font[];

#define BRIGHTNESS 64

#define I2C_ADDR 0x74
#define REG_MODE 0x0
#define REG_FRAME 0x1
#define REG_AUDIOSYNC 0x6
#define REG_SHUTDOWN 0xa

#define REG_ENABLE 0x00
#define REG_BLINK 0x12
#define REG_COLOR 0x24

#define REG_BANK 0xfd
#define BANK_CONFIG 0xb

/* imgbuf -- brightness data for each LED */
static byte imgbuf[144];

static void draw_char(char c, int x) {
     byte const *p = &font[CHARWD*c];

     for (int i = 0; i < CHARWD; i++) {
          if (x+i < 0 || x+i >= DISPWD) continue;

          byte b = p[i];
          for (int j = 0; j < CHARHT; j++) {
               if (b & (1 << j))
                    imgbuf[map[j][x+i]] = BRIGHTNESS;
          }
     }
}
                    
static void show(void) {
     static int frame = 0;

     i2c_write_reg(I2C_ADDR, REG_BANK, frame);
     i2c_write_buf(I2C_ADDR, REG_COLOR, imgbuf, 144);
     i2c_write_reg(I2C_ADDR, REG_BANK, BANK_CONFIG);
     i2c_write_reg(I2C_ADDR, REG_FRAME, frame);

     frame = 1-frame;
}

static void init_display(void) {
     i2c_write_reg(I2C_ADDR, REG_BANK, BANK_CONFIG);
     timer_delay(1);
     i2c_write_reg(I2C_ADDR, REG_SHUTDOWN, 0);
     timer_delay(1);
     i2c_write_reg(I2C_ADDR, REG_SHUTDOWN, 1);
     timer_delay(1);
     i2c_write_reg(I2C_ADDR, REG_MODE, 0);
     i2c_write_reg(I2C_ADDR, REG_AUDIOSYNC, 0);

     // Enable each LED: unwired LEDs must be disabled for Charlieplexing.
     memset(imgbuf, 0x7f, 17);  // LEDs 0-6, 8-14, ..., 128-134 on
     imgbuf[17] = 0;            // LEDs 136-143 off
     i2c_write_reg(I2C_ADDR, REG_BANK, 0);
     i2c_write_buf(I2C_ADDR, REG_ENABLE, imgbuf, 18);
     i2c_write_reg(I2C_ADDR, REG_BANK, 1);
     i2c_write_buf(I2C_ADDR, REG_ENABLE, imgbuf, 18);

     // Disable blinking for each LED
     memset(imgbuf, 0, 18);
     i2c_write_reg(I2C_ADDR, REG_BANK, 0);
     i2c_write_buf(I2C_ADDR, REG_BLINK, imgbuf, 18);
     i2c_write_reg(I2C_ADDR, REG_BANK, 1);
     i2c_write_buf(I2C_ADDR, REG_BLINK, imgbuf, 18);
}

static void scroll_text(char *s) {
     int n = strlen(s);

     for (int j = 0; j < n && CHARWD*j < DISPWD; j++)
          draw_char(s[j], CHARWD*j);
     show();
     timer_delay(500);

     for (int t = 1; t < CHARWD * n; t++) {
          int b = t/CHARWD;

          memset(imgbuf, 0, 144);

          for (int j = 0; b+j < n && CHARWD*(b+j) < t + DISPWD; j++)
               draw_char(s[b+j], CHARWD*(b+j) - t);
          show();
          timer_delay(60);
     }
}

void scroll(int n) {
     init_display();

     while (1) {
          scroll_text("The following sentence is false:");
          timer_delay(500);
     }
}

void init(void) {
     timer_init();
     i2c_init();
     serial_init();
     start(USER+0, "Scroll", scroll, 0, STACK);
}

const unsigned char font[] = {
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x00
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x01
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x02
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x03
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x04
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x05
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x06
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x07
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x08
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x09
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x0a
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x0b
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x0c
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x0d
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x0e
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x0f

     0x00, 0x00, 0xf8, 0x08, 0x08, 0x08, // 0x10
     0x08, 0x08, 0xf8, 0x00, 0x00, 0x00, // 0x11
     0x00, 0x00, 0x0f, 0x08, 0x08, 0x08, // 0x12
     0x08, 0x08, 0x0f, 0x00, 0x00, 0x00, // 0x13
     0x08, 0x08, 0x08, 0x08, 0x08, 0x08, // 0x14
     0x00, 0x00, 0xff, 0x00, 0x00, 0x00, // 0x15
     0x00, 0xfc, 0x04, 0xf4, 0x14, 0x14, // 0x16
     0x14, 0xf4, 0x04, 0xfc, 0x00, 0x00, // 0x17
     0x00, 0x1f, 0x10, 0x17, 0x14, 0x14, // 0x18
     0x14, 0x17, 0x10, 0x1f, 0x00, 0x00, // 0x19
     0x14, 0x14, 0x14, 0x14, 0x14, 0x14, // 0x1a
     0x00, 0xff, 0x00, 0xff, 0x00, 0x00, // 0x1b
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x1c
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x1d
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x1e
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x1f

     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // (space)
     0x00, 0x00, 0x5f, 0x00, 0x00, 0x00, // !
     0x00, 0x07, 0x00, 0x07, 0x00, 0x00, // "
     0x14, 0x7f, 0x14, 0x7f, 0x14, 0x00, // #
     0x26, 0x49, 0x7f, 0x49, 0x32, 0x00, // $
     0x23, 0x13, 0x08, 0x64, 0x62, 0x00, // %
     0x36, 0x49, 0x55, 0x22, 0x50, 0x00, // &
     0x00, 0x05, 0x03, 0x00, 0x00, 0x00, // '
     0x00, 0x1c, 0x22, 0x41, 0x00, 0x00, // (
     0x00, 0x41, 0x22, 0x1c, 0x00, 0x00, // )
     0x08, 0x2a, 0x1c, 0x2a, 0x08, 0x00, // *
     0x08, 0x08, 0x3e, 0x08, 0x08, 0x00, // +
     0x00, 0x50, 0x30, 0x00, 0x00, 0x00, // ,
     0x08, 0x08, 0x08, 0x08, 0x08, 0x00, // -
     0x00, 0x60, 0x60, 0x00, 0x00, 0x00, // .
     0x60, 0x10, 0x08, 0x04, 0x03, 0x00, // /

     0x3e, 0x41, 0x49, 0x41, 0x3e, 0x00, // 0
     0x00, 0x42, 0x7f, 0x40, 0x00, 0x00, // 1
     0x42, 0x61, 0x51, 0x49, 0x46, 0x00, // 2
     0x22, 0x41, 0x49, 0x49, 0x36, 0x00, // 3
     0x18, 0x14, 0x12, 0x7f, 0x10, 0x00, // 4
     0x27, 0x45, 0x45, 0x45, 0x39, 0x00, // 5
     0x3c, 0x4a, 0x49, 0x49, 0x30, 0x00, // 6
     0x01, 0x71, 0x09, 0x05, 0x03, 0x00, // 7
     0x36, 0x49, 0x49, 0x49, 0x36, 0x00, // 8
     0x06, 0x49, 0x49, 0x49, 0x3e, 0x00, // 9
     0x00, 0x36, 0x36, 0x00, 0x00, 0x00, // :
     0x00, 0x56, 0x36, 0x00, 0x00, 0x00, // ;
     0x08, 0x08, 0x14, 0x22, 0x22, 0x00, // <
     0x14, 0x14, 0x14, 0x14, 0x14, 0x00, // =
     0x22, 0x22, 0x14, 0x08, 0x08, 0x00, // >
     0x02, 0x01, 0x51, 0x09, 0x06, 0x00, // ?

     0x32, 0x49, 0x79, 0x41, 0x3e, 0x00, // @
     0x7e, 0x09, 0x09, 0x09, 0x7e, 0x00, // A
     0x7f, 0x49, 0x49, 0x49, 0x36, 0x00, // B
     0x3e, 0x41, 0x41, 0x41, 0x22, 0x00, // C
     0x7f, 0x41, 0x41, 0x22, 0x1c, 0x00, // D
     0x7f, 0x49, 0x49, 0x41, 0x41, 0x00, // E
     0x7f, 0x09, 0x09, 0x01, 0x01, 0x00, // F
     0x3e, 0x41, 0x41, 0x49, 0x39, 0x00, // G
     0x7f, 0x08, 0x08, 0x08, 0x7f, 0x00, // H
     0x00, 0x41, 0x7f, 0x41, 0x00, 0x00, // I
     0x20, 0x40, 0x41, 0x3f, 0x01, 0x00, // J
     0x7f, 0x08, 0x14, 0x22, 0x41, 0x00, // K
     0x7f, 0x40, 0x40, 0x40, 0x40, 0x00, // L
     0x7f, 0x02, 0x0c, 0x02, 0x7f, 0x00, // M
     0x7f, 0x02, 0x04, 0x08, 0x7f, 0x00, // N
     0x3e, 0x41, 0x41, 0x41, 0x3e, 0x00, // O

     0x7f, 0x09, 0x09, 0x09, 0x06, 0x00, // P
     0x3e, 0x41, 0x51, 0x21, 0x5e, 0x00, // Q
     0x7f, 0x09, 0x19, 0x29, 0x46, 0x00, // R
     0x26, 0x49, 0x49, 0x49, 0x32, 0x00, // S
     0x01, 0x01, 0x7f, 0x01, 0x01, 0x00, // T
     0x3f, 0x40, 0x40, 0x40, 0x3f, 0x00, // U
     0x0f, 0x10, 0x60, 0x10, 0x0f, 0x00, // V
     0x7f, 0x20, 0x18, 0x20, 0x7f, 0x00, // W
     0x63, 0x14, 0x08, 0x14, 0x63, 0x00, // X
     0x03, 0x04, 0x78, 0x04, 0x03, 0x00, // Y
     0x61, 0x51, 0x49, 0x45, 0x43, 0x00, // Z
     0x00, 0x00, 0x7f, 0x41, 0x41, 0x00, // [
     0x03, 0x04, 0x08, 0x10, 0x60, 0x00, // "\"
     0x41, 0x41, 0x7f, 0x00, 0x00, 0x00, // ]
     0x04, 0x02, 0x01, 0x02, 0x04, 0x00, // ^
     0x40, 0x40, 0x40, 0x40, 0x40, 0x00, // _

     0x00, 0x00, 0x03, 0x05, 0x00, 0x00, // `
     0x20, 0x54, 0x54, 0x54, 0x78, 0x00, // a
     0x7f, 0x48, 0x44, 0x44, 0x38, 0x00, // b
     0x38, 0x44, 0x44, 0x44, 0x48, 0x00, // c
     0x38, 0x44, 0x44, 0x48, 0x7f, 0x00, // d
     0x38, 0x54, 0x54, 0x54, 0x58, 0x00, // e
     0x08, 0x7e, 0x09, 0x01, 0x02, 0x00, // f
     0x48, 0x54, 0x54, 0x54, 0x3c, 0x00, // g
     0x7f, 0x08, 0x04, 0x04, 0x78, 0x00, // h
     0x00, 0x44, 0x7d, 0x40, 0x00, 0x00, // i
     0x20, 0x40, 0x44, 0x3d, 0x00, 0x00, // j
     0x00, 0x7f, 0x10, 0x28, 0x44, 0x00, // k
     0x00, 0x41, 0x7f, 0x40, 0x00, 0x00, // l
     0x7c, 0x04, 0x18, 0x04, 0x78, 0x00, // m
     0x7c, 0x08, 0x04, 0x04, 0x78, 0x00, // n
     0x38, 0x44, 0x44, 0x44, 0x38, 0x00, // o

     0x7c, 0x14, 0x14, 0x14, 0x08, 0x00, // p
     0x38, 0x44, 0x54, 0x24, 0x58, 0x00, // q
     0x7c, 0x08, 0x04, 0x04, 0x08, 0x00, // r
     0x48, 0x54, 0x54, 0x54, 0x24, 0x00, // s
     0x04, 0x3f, 0x44, 0x40, 0x20, 0x00, // t
     0x3c, 0x40, 0x40, 0x20, 0x7c, 0x00, // u
     0x1c, 0x20, 0x40, 0x20, 0x1c, 0x00, // v
     0x3c, 0x40, 0x30, 0x40, 0x3c, 0x00, // w
     0x44, 0x28, 0x10, 0x28, 0x44, 0x00, // x
     0x0c, 0x50, 0x50, 0x50, 0x3c, 0x00, // y
     0x44, 0x64, 0x54, 0x4c, 0x44, 0x00, // z
     0x00, 0x08, 0x36, 0x41, 0x00, 0x00, // {
     0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, // |
     0x00, 0x41, 0x36, 0x08, 0x00, 0x00, // }
     0x08, 0x04, 0x08, 0x10, 0x08, 0x00, // ~
     0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x00  // DEL
};
